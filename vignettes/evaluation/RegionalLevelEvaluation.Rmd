---
title: "Evaluation of regional-level forest dynamics with forest inventory data"
author: "Miquel De Cáceres"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_document:
    df_print: paged
    toc: TRUE
params:
  minTreeRecords: 200
  minPlotRecords: 100
  minPlotRecordsDetailed: 100
---

```{r setup, include=FALSE}
library(kableExtra)
library(sf)
library(knitr)
library(medfate)
library(ggplot2)
library(cowplot)
library(tidyverse)
evalDIR = "~/OneDrive/Professional/MedfateWorks/RegionalLevelEvaluation"
```

## Introduction

```{r, echo = FALSE}
eval_res_basic <- readRDS(paste0(evalDIR, "/Rdata/IFNeval_results_basic.rds"))
eval_res_advanced <- readRDS(paste0(evalDIR, "/Rdata/IFNeval_results_advanced.rds"))

SpParams_bas = eval_res_basic$SpParams
target_spp_bas = eval_res_basic$target_spp
target_IDs_bas = eval_res_basic$target_IDs

SpParams_adv = eval_res_advanced$SpParams
target_spp_adv = eval_res_advanced$target_spp
target_IDs_adv = eval_res_advanced$target_IDs

dfdbh_bas = eval_res_basic$dfdbh
dfdbh_bas$Submodel = "Basic"
dfh_bas = eval_res_basic$dfh
dfh_bas$Submodel = "Basic"
dfbadead_bas = eval_res_basic$dfbadead
dfbadead_bas$Submodel = "Basic"
dfbarecr_bas = eval_res_basic$dfbarecr
dfbarecr_bas$Submodel = "Basic"
dfbai_bas = eval_res_basic$dfbai
dfbai_bas$Submodel = "Basic"
dfbai_all_bas = eval_res_basic$dfbasum
dfbai_all_bas$Submodel = "Basic"
mapdata_bas = eval_res_basic$mapdata
medfate_ver_bas = eval_res_basic$package.version

dfdbh_adv = eval_res_advanced$dfdbh
dfdbh_adv$Submodel = "Advanced"
dfh_adv = eval_res_advanced$dfh
dfh_adv$Submodel = "Advanced"
dfbadead_adv = eval_res_advanced$dfbadead
dfbadead_adv$Submodel = "Advanced"
dfbarecr_adv = eval_res_advanced$dfbarecr
dfbarecr_adv$Submodel = "Advanced"
dfbai_adv = eval_res_advanced$dfbai
dfbai_adv$Submodel = "Advanced"
dfbai_all_adv = eval_res_advanced$dfbasum
dfbai_all_adv$Submodel = "Advanced"
mapdata_adv = eval_res_advanced$mapdata
medfate_ver_adv = eval_res_advanced$package.version

dfdbh <- rbind(dfdbh_bas, dfdbh_adv)
dfh <- rbind(dfh_bas, dfh_adv)
dfbai <- rbind(dfbai_bas, dfbai_adv)
dfbadead <- rbind(dfbadead_bas, dfbadead_adv)
dfbarecr <- rbind(dfbarecr_bas, dfbarecr_adv)
# dfbai_all_bas <-dfbai_all_bas[dfbai_all_bas$ID %in% dfbai_all_adv$ID,]
dfbai_all <- rbind(dfbai_all_bas, dfbai_all_adv)
dfdbh$Submodel <- factor(dfdbh$Submodel, levels =c("Basic","Advanced"))
dfh$Submodel <- factor(dfh$Submodel, levels =c("Basic","Advanced"))
dfbai$Submodel <- factor(dfbai$Submodel, levels =c("Basic","Advanced"))
dfbadead$Submodel <- factor(dfbadead$Submodel, levels =c("Basic","Advanced"))
dfbarecr$Submodel <- factor(dfbarecr$Submodel, levels =c("Basic","Advanced"))
dfbai_all$Submodel <- factor(dfbai_all$Submodel, levels =c("Basic","Advanced"))
 
dfdbh$Province = substr(dfdbh$ID, 1, nchar(dfdbh$ID)-4)
 
load("~/OneDrive/Datasets/Limits/Products/Catalonia/catalonia.rdata")
cat_sfc = sf::st_as_sfc(cat.contour)
```

### Goal

The aim of this article is to provide an assessment of the performance of `fordyn` for the prediction of forest dynamics in Catalonia (NE of Spain). To this aim, we simulate forest dynamics between two surveys of the Spanish National Forest Inventory and compare the model predictions of forest growth against inventory data for a large set of permanent plots. The evaluation focuses first on the growth (in diameter and height) of surviving trees, then turning the attention to the basal area of dead trees and overall changes in basal area.

This evaluation was conducted using **medfate** package version **`r medfate_ver_bas`**.



```{r, echo = FALSE}
plot_scatter_dbh<-function(dfdbh, points = TRUE, submodel = ""){
g1<-ggplot(dfdbh, aes(x = pred, y= obs))
if(points) g1 <- g1 +  geom_point(size=0.3, col="dark gray", alpha = 0.3)
g1 <- g1 +  geom_abline(intercept = 0, slope = 1, col ="black")+
  xlab("Predicted diameter increment (cm/yr)")+
  ylab("Observed diameter increment (cm/yr)")+
  labs(title = submodel)+
  xlim(c(0,1.5))+ ylim(c(0,1.5))+
  theme_bw()
g2<-ggplot(dfdbh, aes(x = DBH3, y= error))
if(points) g2 <- g2 +  geom_point(size=0.3, col="dark gray", alpha = 0.3)
g2 <- g2 +  geom_abline(intercept = 0, slope = 0, col ="black")+
  geom_smooth(method="gam", formula = y ~ s(x, bs = "cs"), col="red")+
  xlab("Initial diameter (cm)")+
  ylab("Error diameter increment (cm/yr)")+
  ylim(c(-1.5,1.5))+xlim(c(0,50))+
  labs(title = " ")+
  theme_bw()
  plot_grid(g1, g2, nrow=1)
}

plot_scatter_bai<-function(dfbai, quantity = "basal area increment", xylim = c(0,20), errorlim = c(-20,20), submodel = "") {
g3<-ggplot(dfbai, aes(x = pred, y= obs))+
  geom_point(size=0.3, col="dark gray", alpha = 0.3)+
  geom_abline(intercept = 0, slope = 1, col ="black")+
  xlab(paste0("Predicted ", quantity," (m2/ha)"))+
  ylab(paste0("Observed ", quantity," (m2/ha)"))+
  labs(title = submodel)+
  xlim(xylim)+ ylim(xylim)+
  theme_bw()
g4<-ggplot(dfbai, aes(x = ini, y= error))+
  geom_point(size=0.3, col="dark gray", alpha = 0.3)+
  geom_abline(intercept = 0, slope = 0, col ="black")+
  geom_smooth(method=NULL, formula = y ~ x, col="red")+
  xlab("Initial basal area (m2/ha)")+
  ylab(paste0("Error ", quantity," (m2/ha)"))+
  labs(title = " ")+
  xlim(c(0,30))+ylim(errorlim)+
  theme_bw()
  plot_grid(g3, g4, nrow=1)
}

plot_cov_clim_dbh<-function(dfdbh, points = TRUE){
  dfdbh$PPET[dfdbh$PPET>2] = 2
  df = bind_rows(data.frame(MAT = dfdbh$MAT, PPET = dfdbh$PPET, PAR = dfdbh$light, value = dfdbh$obs, type="Observed"),
                 data.frame(MAT = dfdbh$MAT, PPET = dfdbh$PPET, PAR = dfdbh$light, value = dfdbh$pred, type="Predicted"))
  g1<-ggplot(df, aes(x = PPET, y=value))
  if(points) g1 <- g1 + geom_point(aes(col = type), size=0.3, alpha = 0.3)
  g1 <- g1 + geom_smooth(aes(col = type), method="gam", formula = y ~ s(x, bs = "cs"))+
    ylab("Annual diameter increment (cm/yr)")+ ylim(c(0,1.5))+
    xlab("Moisture index (P/PET)")+
    scale_color_discrete("")+
    theme_bw()+
    theme(legend.position = c(0.75,0.85), legend.background = element_blank())
  g2<-ggplot(dfdbh, aes(x = PPET, y=error))
  if(points) g2 <- g2 + geom_point(col = "dark gray", size=0.3, alpha = 0.3)
  g2 <- g2 + geom_smooth(aes(x = PPET, y=error), formula = y ~ s(x, bs = "cs"), method="gam", col= "red")+
    geom_abline(intercept = 0, slope = 0, col ="black")+
    ylab("Annual diameter increment error (cm)")+ylim(c(-1.5,1.5))+
    xlab("Moisture index (P/PET)")+
    theme_bw()
  g3<-ggplot(df, aes(x = MAT, y=value))
  if(points) g3 <- g3 + geom_point(aes(col = type), size=0.3, alpha = 0.3)
  g3 <- g3 + geom_smooth(aes(col = type), method="gam", formula = y ~ s(x, bs = "cs"))+
    ylab("Annual diameter increment (cm/yr)")+ylim(c(0,1.5))+
    xlab("Mean annual temperature (ºC)")+
    scale_color_discrete("")+
    theme_bw()+
    theme(legend.position = c(0.75,0.85), legend.background = element_blank())
  g4<-ggplot(dfdbh, aes(x = MAT, y=error))
  if(points) g4 <- g4 + geom_point(col= "dark gray", size=0.3, alpha = 0.3)
  g4 <- g4 + geom_smooth(formula = y ~ s(x, bs = "cs"), method="gam", col= "red")+
    geom_abline(intercept = 0, slope = 0, col ="black")+
    ylab("Annual diameter increment error (cm)")+ylim(c(-1.5,1.5))+
    xlab("Mean annual temperature (ºC)")+
    theme_bw()
  g5<-ggplot(df, aes(x = PAR, y=value))
  if(points) g5 <- g5 + geom_point(aes(col = type), size=0.3, alpha = 0.3)
  g5 <- g5 + geom_smooth(aes(col = type), method="gam", formula = y ~ s(x, bs = "cs"))+
    ylab("Annual diameter increment (cm/yr)")+ylim(c(0,1.5))+
    xlab("Available PAR (%)")+
    scale_color_discrete("")+
    theme_bw()+
    theme(legend.position = c(0.75,0.85), legend.background = element_blank())
  g6<-ggplot(dfdbh, aes(x = light, y=error))
  if(points) g6 <- g6 + geom_point(col= "dark gray", size=0.3, alpha = 0.3)
  g6 <- g6 + geom_smooth(formula = y ~ s(x, bs = "cs"), method="gam", col= "red")+
    geom_abline(intercept = 0, slope = 0, col ="black")+
    ylab("Annual diameter increment error (cm)")+ylim(c(-1.5,1.5))+
    xlab("Available PAR (%)")+
    theme_bw()
  plot_grid(g1, g2, g3, g4, g5,g6, nrow=3)
}

plot_cov_clim_bai<-function(dfbai, quantity = "Basal area increment", ylim = c(0,20), errorlim = c(-20,20)){
  dfbai$PPET[dfbai$PPET>2] = 2
  df = bind_rows(data.frame(MAT = dfbai$MAT, PPET = dfbai$PPET, value = dfbai$obs, type="Observed"),
                 data.frame(MAT = dfbai$MAT, PPET = dfbai$PPET, value = dfbai$pred, type="Predicted"))
  g1<-ggplot(df)+
    geom_point(aes(x = PPET, y=value, col = type), size=0.3, alpha = 0.3)+
    geom_smooth(aes(x = PPET, y=value, col = type), method="loess", formula = y ~ x)+
    ylab(paste0(quantity," (m2/ha)"))+ ylim(ylim)+
    xlab("Moisture index (P/PET)")+
    scale_color_discrete("")+
    theme_bw()+
    theme(legend.position = c(0.75,0.85), legend.background = element_blank())
  g2<-ggplot(dfbai)+
    geom_point(aes(x = PPET, y=error), col= "dark gray", size=0.3, alpha = 0.3)+
    geom_smooth(aes(x = PPET, y=error), method="loess", formula = y ~ x, col= "red")+
    geom_abline(intercept = 0, slope = 0, col ="black")+
    ylab(paste0(quantity," error (m2/ha)"))+ylim(errorlim)+
    xlab("Moisture index (P/PET)")+
    theme_bw()
  g3<-ggplot(df)+
    geom_point(aes(x = MAT, y=value, col = type), size=0.3, alpha = 0.3)+
    geom_smooth(aes(x = MAT, y=value, col = type), method="loess", formula = y ~ x)+
    ylab(paste0(quantity," (m2/ha)"))+ ylim(ylim)+
    xlab("Mean annual temperature (ºC)")+
    scale_color_discrete("")+theme_bw()+
    theme(legend.position = c(0.75,0.85), legend.background = element_blank())
    
  g4<-ggplot(dfbai)+
    geom_point(aes(x = MAT, y=error), col= "dark gray", size=0.3, alpha = 0.3)+
    geom_smooth(aes(x = MAT, y=error), method="loess", formula = y ~ x, col= "red")+
    geom_abline(intercept = 0, slope = 0, col ="black")+
    ylab(paste0(quantity," error (m2/ha)"))+ ylim(errorlim)+
    xlab("Mean annual temperature (ºC)")+
    theme_bw()
  plot_grid(g1, g2, g3, g4, nrow=2)
}

bai_error_map <-function(data_bai, upper = 10, lower = -10){
  data_bai = data_bai[!is.na(data_bai$error),]
  data_bai$error[data_bai$error > upper] = upper
  data_bai$error[data_bai$error < lower] = lower
  ggplot(data_bai)+
    geom_sf(aes(col=error), size=0.5)+
    geom_sf(data = cat_sfc)+
    scale_color_fermenter("m2/ha",palette = 1, breaks = c(lower,lower*0.5,lower*0.25,lower*0.1, 0, upper*0.1,upper*0.25,upper*0.5,upper), 
                       type = 'div', direction = 2, na.value = 'transparent')+
    # scale_color_gradient2("m2/ha",low="blue", mid="yellow", high="red")+
    theme_bw()+
    theme(panel.grid = element_blank())
    # theme(panel.grid = element_blank(), legend.position = c(0.85,0.25))
}
```

### Simulation procedure


We selected **`r length(target_IDs_bas)`** repeated plots (A1 between IFN3 and IFN4) without signs of management (cut trees) and whose basal area did not decrease between inventory surveys.

Soil physical properties were drawn from SoilGrids (Hengl 2016), complemented by rock fragment content estimates derived from surface stoniness measurements in forest plots. Simulations were conducted between 2000/2001 (IFN3) and 2014/2016 (IFN4) depending on the sampling years of the target plot, with daily weather data obtained via interpolation on plot's coordinates using package **meteoland**. 

Default species-specific parameters were modified using the results of the [meta-modelling exercise](https://emf-creaf.github.io/medfate/articles/parametrization/Metamodelling.html) and the [growth calibration exercise](https://emf-creaf.github.io/medfate/articles/parametrization/GrowthCalibration.html). These two exercises do not provide values for all the main species included here, so it is expected that evaluation results are worse for those species not included in those exercises.

Simulations were done for both the **basic** and **advanced** transpiration/photosynthesis sub-models. On a server with 20 parallel threads, computational times are around **5 hours** (i.e. 2 min/plot) for the **basic** sub-model, versus around **10 days** (i.e. 1.6 hrs/plot) for the **advanced** submodel. The average number of tree cohorts per plot is **`r round(nrow(dfdbh_bas)/length(unique(dfdbh_bas$ID)))`**.

```{r, echo = FALSE}
# 
# df = SpParams_bas[SpParams_bas$SpIndex %in% target_spp_bas, c("Name", "Tmax_LAI", "Tmax_LAIsq", "WUE","Al2As", "SLA", "RGRcambiummax", "fHDmin", "fHDmax", "MortalityBaselineRate")]
# row.names(df) = NULL
# df %>%
#   kbl() %>%
#   kable_styling()
```

In the following sections, we provide the bias, mean absolute error (both in absolute and relative terms) and R-squared of growth and mortality predictions at the tree-level and stand-level obtained by simulations with both sub-models. Scatter plots are provided to represent the relationship between predicted and observed values, as well as the factors that may influence the direction and magnitude of prediction error (i.e. initial values, environmental conditions, ...).  

<!-- Detailed results of growth evaluation by species are provided in the last section. -->

## Growth of surviving trees

Comparison of growth of trees (DBH >= 7.5) that survived in both observed and simulated data.

### Annual diameter increment (cm/yr)

Overall predictive capacity:
```{r, echo = FALSE}
res1<-dfdbh %>% group_by(Submodel) %>% 
  summarize(Province = "All",
            Name = "All", 
            n = n(),
            Obs = mean(obs, na.rm=TRUE),
            Pred = mean(pred, na.rm=TRUE),
            Bias = mean(error, na.rm=TRUE),
            Biasrel = 100*Bias/abs(Obs),
            RMSQ = sqrt(mean(error^2, na.rm=TRUE)),
            RMSQrel = 100*RMSQ/abs(Obs),
            R2 = cor(obs,pred)^2, .groups="drop") 
# res2<-dfdbh %>% group_by(Province,Submodel) %>% 
#   summarize(Name = "All", 
#             n = n(),
#             Obs = mean(obs, na.rm=TRUE),
#             Pred = mean(pred, na.rm=TRUE),
#             Bias = mean(error, na.rm=TRUE),
#             Biasrel = 100*Bias/abs(Obs),
#             RMSQ = sqrt(mean(error^2, na.rm=TRUE)),
#             RMSQrel = 100*RMSQ/abs(Obs),
#             R2 = cor(obs,pred)^2, .groups="drop")
# res <-bind_rows(res1,res2)
res1[,-c(2,3)] %>% 
  kbl() %>%
  kable_styling()
```



Predictive capacity plots:

```{r, echo = FALSE, fig.width=8, fig.height=8, warning=FALSE, message=FALSE}
p1<-plot_scatter_dbh(dfdbh_bas, points = TRUE, submodel = "Basic")
p2<-plot_scatter_dbh(dfdbh_adv, points = TRUE, submodel = "Advanced")
plot_grid(p1, p2, nrow=2)
```


Relationship between diameter increase and climatic variables (MAT, P/PET and available PAR) for the **basic** sub-model:

```{r, echo = FALSE, fig.width=8, fig.height=12, warning=FALSE, message=FALSE}
plot_cov_clim_dbh(dfdbh_bas, points = TRUE)
```

Relationship between diameter increase and climatic variables (MAT, P/PET and available PAR) for the **advanced** sub-model:

```{r, echo = FALSE, fig.width=8, fig.height=12, warning=FALSE, message=FALSE}
plot_cov_clim_dbh(dfdbh_adv, points = TRUE)
```

Predictive capacity by species (for species with > `r params$minTreeRecords` tree records):

```{r, echo = FALSE}
dfdbh %>% group_by(Name,Submodel) %>%
  summarize(n = n(),
            Obs = mean(obs, na.rm=TRUE),
            Pred = mean(pred, na.rm=TRUE),
            Bias = mean(error, na.rm=TRUE),
            Biasrel = 100*Bias/abs(Obs),
            RMSQ = sqrt(mean(error^2, na.rm=TRUE)),
            RMSQrel = 100*RMSQ/abs(Obs),
            R2 = cor(obs,pred)^2, .groups = "drop") %>% 
  filter(n>=params$minTreeRecords) %>%
  kbl() %>%
  kable_styling()
```

### Annual height increment (cm/yr)

Overall predictive capacity:
```{r, echo = FALSE}
dfh %>% group_by(Submodel) %>% 
  summarize(Name = "All",
            n = n(),
            Obs = mean(obs, na.rm=TRUE),
            Pred = mean(pred, na.rm=TRUE),
            Bias = mean(error, na.rm=TRUE),
            Biasrel = 100*Bias/abs(Obs),
            RMSQ = sqrt(mean(error^2, na.rm=TRUE)),
            RMSQrel = 100*RMSQ/abs(Obs),
            R2 = cor(obs,pred)^2) %>%
  kbl() %>%
  kable_styling()
```

Predictive capacity by species (for species with > `r params$minTreeRecords` tree records):

```{r, echo = FALSE}
dfh %>% group_by(Name, Submodel) %>%
  summarize(n = n(),
            Obs = mean(obs, na.rm=TRUE),
            Pred = mean(pred, na.rm=TRUE),
            Bias = mean(error, na.rm=TRUE),
            Biasrel = 100*Bias/abs(Obs),
            RMSQ = sqrt(mean(error^2, na.rm=TRUE)),
            RMSQrel = 100*RMSQ/abs(Obs),
            R2 = cor(obs,pred)^2, .groups = "drop")%>% 
  filter(n>=params$minTreeRecords) %>%
  kbl() %>%
  kable_styling()
```


### Stand-level basal area increment (m2/ha)

This comparison does not take into account changes in density. In other words, densities from IFN3 are used to calculate stand-level basal area of surviving trees. It is meant to evaluate the effect of diameter increment of surviving trees in terms of stand basal area increments.


Predictive capacity table:
```{r, echo = FALSE}
dfbai[dfbai$Name=="0-All",] %>% group_by(Submodel) %>% 
  summarize(Name = "All",
            n = n(),
            Obs = mean(obs, na.rm=TRUE),
            Pred = mean(pred, na.rm=TRUE),
            Bias = mean(error, na.rm=TRUE),
            Biasrel = 100*Bias/abs(Obs),
            RMSQ = sqrt(mean(error^2, na.rm=TRUE)),
            RMSQrel = 100*RMSQ/abs(Obs),
            R2 = cor(obs,pred)^2) %>% 
  kbl() %>%
  kable_styling()
```

Predictive capacity plots:

```{r, echo = FALSE, fig.width=8, fig.height=8, warning=FALSE, message=FALSE}
p1<-plot_scatter_bai(dfbai_bas[dfbai_bas$Name=="0-All",], submodel = "Basic")
p2<-plot_scatter_bai(dfbai_adv[dfbai_adv$Name=="0-All",], submodel = "Advanced")
plot_grid(p1, p2, nrow=2)
```

Relationship between basal area increase and climatic variables (MAT and P/PET) for the **basic** sub-model:

```{r, echo = FALSE, fig.width=8, fig.height=8, warning=FALSE, message=FALSE}
plot_cov_clim_bai(dfbai_bas[dfbai_bas$Name=="0-All",])
```


Relationship between basal area increase and climatic variables (MAT and P/PET) for the **advanced** sub-model:

```{r, echo = FALSE, fig.width=8, fig.height=8, warning=FALSE, message=FALSE}
plot_cov_clim_bai(dfbai_adv[dfbai_adv$Name=="0-All",])
```

Spatial error distribution:

```{r, echo = FALSE, fig.width=9, fig.height=4}
map_data_bai = mapdata_bas
map_data_bai$error = dfbai_bas$error[dfbai_bas$Name=="0-All"]
p1<-bai_error_map(map_data_bai)+labs(title="Basic")
map_data_bai = mapdata_adv
map_data_bai$error = dfbai_adv$error[dfbai_adv$Name=="0-All"]
p2<-bai_error_map(map_data_bai)+labs(title="Advanced")
plot_grid(p1+theme(legend.position = "none"),p2+theme(legend.position = "none"),
          get_legend(p1),nrow=1, rel_widths = c(1,1,0.25))
```


Predictive capacity by species (occurring in more than `r params$minPlotRecords` plots):
```{r, echo = FALSE}
dfbai[dfbai$Name!="0-All",] %>% group_by(Name, Submodel) %>%
  summarize(n = n(),
            Obs = mean(obs, na.rm=TRUE),
            Pred = mean(pred, na.rm=TRUE),
            Bias = mean(error, na.rm=TRUE),
            Biasrel = 100*Bias/abs(Obs),
            RMSQ = sqrt(mean(error^2, na.rm=TRUE)),
            RMSQrel = 100*RMSQ/abs(Obs),
            R2 = cor(obs,pred)^2, .groups = "drop") %>% 
  filter(n>=params$minPlotRecords) %>%
  kbl() %>%
  kable_styling()
```

## Mortality (m2/ha)

Reduction of basal area due to trees (DBH >= 7.5) that died during the IFN3-IFN4 period against model's mortality prediction.


Overall predictive capacity:

```{r, echo = FALSE, warning=FALSE}
dfbadead[dfbadead$Name=="0-All",] %>% group_by(Submodel) %>% 
  summarize(Name = "All",
            n = n(),
            Obs = mean(obs, na.rm=TRUE),
            Pred = mean(pred, na.rm=TRUE),
            Bias = mean(error, na.rm=TRUE),
            Biasrel = 100*Bias/abs(Obs),
            RMSQ = sqrt(mean(error^2, na.rm=TRUE)),
            RMSQrel = 100*RMSQ/abs(Obs),
            R2 = cor(obs,pred)^2) %>% 
  kbl() %>%
  kable_styling()
```

Predictive capacity plots:

```{r, echo = FALSE, fig.width=8, fig.height=8, warning=FALSE, message = FALSE}
p1<-plot_scatter_bai(dfbadead_bas[dfbadead_bas$Name=="0-All", ], 
                 quantity = "dead basal area", xylim = c(0,10), errorlim = c(-10,10), submodel="Basic") 
p2<-plot_scatter_bai(dfbadead_adv[dfbadead_adv$Name=="0-All", ], 
                 quantity = "dead basal area", xylim = c(0,10), errorlim = c(-10,10), submodel="Advanced")
plot_grid(p1, p2, nrow=2)
```

Relationship between dead basal area and climatic variables (MAT and P/PET) for the **basic** sub-model:

```{r, echo = FALSE, fig.width=8, fig.height=8, warning=FALSE, message=FALSE}
plot_cov_clim_bai(dfbadead_bas[dfbadead_bas$Name=="0-All",], 
                  quantity = "Dead basal area", ylim = c(0,10), errorlim = c(-10,10))
```

Relationship between dead basal area and climatic variables (MAT and P/PET) for the **advanced** sub-model:

```{r, echo = FALSE, fig.width=8, fig.height=8, warning=FALSE, message=FALSE}
plot_cov_clim_bai(dfbadead_adv[dfbadead_adv$Name=="0-All",], 
                  quantity = "Dead basal area", ylim = c(0,10), errorlim = c(-10,10))
```

Spatial distribution of errors:

```{r, echo = FALSE, fig.width=9, fig.height=4}
mapdata_badead = mapdata_bas
mapdata_badead$error = dfbadead_bas$error[dfbadead_bas$Name=="0-All"]
p1<-bai_error_map(mapdata_badead, upper = 5, lower = -5)+labs(title="Basic")
mapdata_badead = mapdata_adv
mapdata_badead$error = dfbadead_adv$error[dfbadead_adv$Name=="0-All"]
p2<-bai_error_map(mapdata_badead, upper = 5, lower = -5)+labs(title="Advanced")
plot_grid(p1+theme(legend.position = "none"),p2+theme(legend.position = "none"),
          get_legend(p1),nrow=1, rel_widths = c(1,1,0.25))
```

Predictive capacity by species (occurring in more than `r params$minPlotRecords` plots):

```{r, echo = FALSE, warning=FALSE}
dfbadead[dfbadead$Name!="0-All",] %>% group_by(Name, Submodel) %>%
  summarize(n = n(),
            Obs = mean(obs, na.rm=TRUE),
            Pred = mean(pred, na.rm=TRUE),
            Bias = mean(error, na.rm=TRUE),
            Biasrel = 100*Bias/abs(Obs),
            RMSQ = sqrt(mean(error^2, na.rm=TRUE)),
            RMSQrel = 100*RMSQ/abs(Obs),
            R2 = cor(obs,pred)^2, .groups = "drop") %>% 
  filter(n>=params$minPlotRecords) %>%
  kbl() %>%
  kable_styling()
```


## Ingrowth (m2/ha)

Increase of basal area due to ingrowth of trees with diameters between 7.5 cm and 12.5 cm during the IFN3-IFN4 period against model's ingrowth prediction.


Overall predictive capacity:

```{r, echo = FALSE, warning=FALSE}
dfbarecr[dfbarecr$Name=="0-All",] %>% group_by(Submodel) %>% 
  summarize(Name = "All",
            n = n(),
            Obs = mean(obs, na.rm=TRUE),
            Pred = mean(pred, na.rm=TRUE),
            Bias = mean(error, na.rm=TRUE),
            Biasrel = 100*Bias/abs(Obs),
            RMSQ = sqrt(mean(error^2, na.rm=TRUE)),
            RMSQrel = 100*RMSQ/abs(Obs),
            R2 = cor(obs,pred)^2) %>% 
  kbl() %>%
  kable_styling()
```

Predictive capacity plots:

```{r, echo = FALSE, fig.width=8, fig.height=8, warning=FALSE, message = FALSE}
p1<-plot_scatter_bai(dfbarecr_bas[dfbarecr_bas$Name=="0-All", ], 
                 quantity = "ingrowth basal area", xylim = c(0,15), errorlim = c(-15,15), submodel="Basic") 
p2<-plot_scatter_bai(dfbarecr_adv[dfbarecr_adv$Name=="0-All", ], 
                 quantity = "ingrowth basal area", xylim = c(0,15), errorlim = c(-15,15), submodel="Advanced")
plot_grid(p1, p2, nrow=2)
```

Relationship between ingrowth basal area and climatic variables (MAT and P/PET) for the **basic** submodel:

```{r, echo = FALSE, fig.width=8, fig.height=8, warning=FALSE, message=FALSE}
plot_cov_clim_bai(dfbarecr_bas[dfbarecr_bas$Name=="0-All",], 
                  quantity = "Ingrowth basal area", ylim = c(0,15), errorlim = c(-15,15))
```

Relationship between ingrowth basal area and climatic variables (MAT and P/PET) for the **advanced** submodel:

```{r, echo = FALSE, fig.width=8, fig.height=8, warning=FALSE, message=FALSE}
plot_cov_clim_bai(dfbarecr_adv[dfbarecr_adv$Name=="0-All",], 
                  quantity = "Ingrowth basal area", ylim = c(0,15), errorlim = c(-15,15))
```

Spatial distribution of errors:

```{r, echo = FALSE, fig.width=9, fig.height=4}
mapdata_barecr = mapdata_bas
mapdata_barecr$error = dfbarecr_bas$error[dfbarecr_bas$Name=="0-All"]
p1<-bai_error_map(mapdata_barecr, upper = 5, lower = -5)+labs(title="Basic")
mapdata_barecr = mapdata_adv
mapdata_barecr$error = dfbarecr_adv$error[dfbarecr_adv$Name=="0-All"]
p2<-bai_error_map(mapdata_barecr, upper = 5, lower = -5)+labs(title="Advanced")
plot_grid(p1+theme(legend.position = "none"),p2+theme(legend.position = "none"),
          get_legend(p1),nrow=1, rel_widths = c(1,1,0.25))
```


Predictive capacity by species (occurring in more than `r params$minPlotRecords` plots):

```{r, echo = FALSE, warning=FALSE}
dfbarecr[dfbarecr$Name!="0-All",] %>% group_by(Name, Submodel) %>%
  summarize(n = n(),
            Obs = mean(obs, na.rm=TRUE),
            Pred = mean(pred, na.rm=TRUE),
            Bias = mean(error, na.rm=TRUE),
            Biasrel = 100*Bias/abs(Obs),
            RMSQ = sqrt(mean(error^2, na.rm=TRUE)),
            RMSQrel = 100*RMSQ/abs(Obs),
            R2 = cor(obs,pred)^2, .groups = "drop") %>% 
  filter(n>=params$minPlotRecords) %>%
  kbl() %>%
  kable_styling()
```


## Overall stand-level basal area change (m2/ha)

This includes growth of surviving trees, mortality reductions and ingrowth (increase in trees with DBH>5) due to sapling growth (in the observed data, this includes also incorporation of trees into large diameter classes due to sampling design).


Overall predictive capacity:

```{r, echo = FALSE, warning=FALSE}
dfbai_all[dfbai_all$Name=="0-All",] %>% group_by(Submodel) %>% 
  summarize(Name = "All",
            n = n(),
            Obs = mean(obs, na.rm=TRUE),
            Pred = mean(pred, na.rm=TRUE),
            Bias = mean(error, na.rm=TRUE),
            Biasrel = 100*Bias/abs(Obs),
            RMSQ = sqrt(mean(error^2, na.rm=TRUE)),
            RMSQrel = 100*RMSQ/abs(Obs),
            R2 = cor(obs,pred)^2) %>% 
  kbl() %>%
  kable_styling()
```


Predictive capacity plot:

```{r, echo = FALSE, fig.width=8, fig.height=8, warning=FALSE, message = FALSE}
p1<-plot_scatter_bai(dfbai_all_bas[dfbai_all_bas$Name=="0-All", ], 
                 quantity = "basal area change", xylim = c(-5,20), errorlim = c(-20,20), submodel="Basic") 
p2<-plot_scatter_bai(dfbai_all_adv[dfbai_all_adv$Name=="0-All", ], 
                 quantity = "basal area change", xylim = c(-5,20), errorlim = c(-20,20), submodel="Advanced")
plot_grid(p1,p2,nrow=2)
```

Relationship between overall basal area change and climatic variables (MAT and P/PET) for the **basic** sub-model:

```{r, echo = FALSE, fig.width=8, fig.height=8, warning=FALSE, message=FALSE}
p2<-plot_cov_clim_bai(dfbai_all_bas[dfbai_all_bas$Name=="0-All",], 
                  quantity = "Basal area change", ylim = c(-5,20), errorlim = c(-20,20))
p2
```

Relationship between overall basal area change and climatic variables (MAT and P/PET) for the **advanced** sub-model:

```{r, echo = FALSE, fig.width=8, fig.height=8, warning=FALSE, message=FALSE}
p3<-plot_cov_clim_bai(dfbai_all_adv[dfbai_all_adv$Name=="0-All",], 
                  quantity = "Basal area change", ylim = c(-5,20), errorlim = c(-20,20))
p3
```

```{r, echo = FALSE}
p0<-cowplot::plot_grid(p1,p2, nrow=2, rel_heights = c(0.33,0.66))
ggsave(paste0(evalDIR,"/Plots/BAtot_eval.png"),p0, width = 8, height=10)
```

Spatial distribution of errors:

```{r, echo = FALSE, fig.width=9, fig.height=4, warning=FALSE, message=FALSE}

mapdata_bac = mapdata_bas
mapdata_bac$error = dfbai_all_bas$error[dfbai_all_bas$Name=="0-All"]
p1<-bai_error_map(mapdata_bac)+labs(title="Basic")
mapdata_bac = mapdata_adv
mapdata_bac$error = dfbai_all_adv$error[dfbai_all_adv$Name=="0-All"]
p2<-bai_error_map(mapdata_bac)+labs(title="Advanced")
pm<-plot_grid(p1+theme(legend.position = "none"),p2+theme(legend.position = "none"),
          get_legend(p1),nrow=1, rel_widths = c(1,1,0.25))
ggsave(paste0(evalDIR,"/Plots/BAtot_error_map.png"),pm, width = 6, height=6)
pm
```


Predictive capacity by species (occurring in more than `r params$minPlotRecords` plots):

```{r, echo = FALSE, warning=FALSE}
dfbai_all[dfbai_all$Name!="0-All",] %>% group_by(Name, Submodel) %>%
  summarize(n = n(),
            Obs = mean(obs, na.rm=TRUE),
            Pred = mean(pred, na.rm=TRUE),
            Bias = mean(error, na.rm=TRUE),
            Biasrel = 100*Bias/abs(Obs),
            RMSQ = sqrt(mean(error^2, na.rm=TRUE)),
            RMSQrel = 100*RMSQ/abs(Obs),
            R2 = cor(obs,pred)^2, .groups = "drop") %>%
  filter(n>=params$minPlotRecords) %>%
  kbl() %>%
  kable_styling()
```


<!-- ## Detailed evaluation by species  -->

<!-- In the following we provide detailed evaluation results for the most important species (those occurring in more than `r params$minPlotRecordsDetailed` plots). -->


```{r, echo=FALSE, results='asis', warning = FALSE, message=FALSE}
# sp_n <- dfbai_all[dfbai_all$Name!="0-All",] %>% group_by(Name) %>%
#     summarize(n = n())
# sp100 = sp_n$Name[sp_n$n>params$minPlotRecordsDetailed]
# target_spp = target_spp[names(target_spp) %in% sp100]
# for(i in 1:length(target_spp)) {
#   
#   sp = target_spp[i]
#   name = names(target_spp)[i]
#   res <- knitr::knit_child('_RLEvaluation_child.Rmd', quiet = TRUE)
#   cat(res, sep = '\n')
# }
```


