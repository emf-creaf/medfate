---
title: "Stand-level model evaluation"
author: "Miquel De Cáceres (CREAF), Víctor Granda (CREAF), Nicolas Martin-StPaul (INRAE)"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_document:
    df_print: paged
    toc: TRUE
---



```{r setup, include=FALSE}
params = list(wd='/home/miquel/OneDrive/mcaceres_work/model_development/medfate_development/StandLevelEvaluation/',
              model='spwb',
              names=c("Puéchabon", "Hesse", "Yatir", "Prades", "Font-Blanche", "Can Balasc", "Armallones"),
              codes=c("FRAPUE", "FRAHES", "ISRYAT", "PRADES",  "FONBLA", "CANBALASC", "ESPALTARM"),
              confs=c('granier','sperry', 'cochard'),
              save_plots = FALSE)

knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(error = TRUE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
library(knitr)
library(kableExtra)
library(medfate)
library(ggplot2)

```

```{r message=FALSE, warning=FALSE}
this_path <- getwd()
knitr::opts_knit$set(root.dir = params$wd)
n_sites <- length(params$codes)
n_confs <- length(params$confs)
n_rows <- n_sites*n_confs
df <- data.frame(Site = rep(NA, n_rows), 
                 Mode = rep(NA, n_rows),
                 Path = rep(NA, n_rows))
df$SiteData = vector("list", n_rows)
df$InputObject = vector("list", n_rows)
df$Result = vector("list",n_rows)
cnt <- 0
df <- tibble::as_tibble(df)
for(i in 1:n_sites) {
  site <- params$codes[i]
  for(j in 1:n_confs) {
    conf <- params$confs[j]
    cnt <- cnt+1
    df$Site[cnt] <- site
    df$Mode[cnt] <- conf
    df$Path[cnt] <- file.path(params$wd, 'Output', packageVersion('medfate')[[1]], params$model, conf, site)
    file_name_input <- file.path(df$Path[cnt],
                       paste0('simulation_input.rds'))
    file_name_output <- file.path(df$Path[cnt],
                       paste0('simulation_result.rds'))
    df$InputObject[[cnt]] <- readRDS(file_name_input)
    df$Result[[cnt]] <-   readRDS(file_name_output)
    df$SiteData[[cnt]] <- medfatereports::load_list(site)
  }
}
knitr::opts_knit$set(root.dir = this_path)
```

# Introduction

This document presents **medfate** (**ver. `r packageVersion('medfate')[[1]]`**) model evaluation results at stand-level, using data from a set of **`r length(params$codes)` experimental forest plots**. Forest water balance simulations (i.e. function `spwb()`) have been conducted using the three transpiration modes (i.e. `Granier`, `Sperry` or `Cochard`). For each forest plot, general information about the site, topography, soil and climate is first presented, followed by a description of model inputs. Then, evaluation results are presented for four different variables:

 a. Stand-level evapo-transpiration.
 b. Soil moisture content of the topmost layer.
 c. Species-level transpiration, scaled from sap-flow data.
 d. Predawn and midday leaf water potentials. 

The main source of observed data is SAPFLUXNET database ([Poyatos et al. 2021](https://essd.copernicus.org/articles/13/2607/2021/)).
 

```{r, echo=FALSE, results='asis', warning = FALSE, message=FALSE}
 for(i in 1:length(params$codes)) {
   site_code <- params$codes[i]
   site_name <- params$names[i]
   res <- knitr::knit_child(file.path(this_path,'_Stand_Evaluation_child.Rmd'), quiet = TRUE)
   cat(res, sep = '\n')
 }
```



