---
title: "Model evaluation in experimental plots"
author: "Miquel De Cáceres (CREAF), Víctor Granda (CREAF),  Rafael Poyatos (CREAF), Nicolas Martin-StPaul (INRAE)"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_document:
    df_print: paged
    toc: TRUE
---



```{r setup, include=FALSE}
params = list(wd='/home/miquel/OneDrive/mcaceres_work/model_development/medfate_development/StandLevelEvaluation/',
              model='spwb',
              # names = c("Puéchabon"),
              # codes = c("FRAPUE"),
              names=c("Puéchabon", "Hesse", "Yatir", "Rinconada", "Vallcebre (Barrol)", "Vallcebre (Sort)",
                      "Fontainbleau-Barbeau", "Davos Seehornwald", "Prades", "Font-Blanche",
                      "Can Balasc", "Armallones", "Ronda"),
              codes=c("FRAPUE", "FRAHES", "ISRYAT", "ESPRIN", "QVALLCEBRE", "PVALLCEBRE",
                      "FONTAINEBLEAU", "DAVOS", "PRADES",  "FONBLA",
                      "CANBALASC", "ESPALTARM", "RONDA"),
              confs=c('granier','sperry', 'cochard'),
              save_plots = FALSE)

knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(error = TRUE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
library(knitr)
library(kableExtra)
library(medfate)
library(ggplot2)

```

```{r message=FALSE, warning=FALSE}
this_path <- getwd()
knitr::opts_knit$set(root.dir = params$wd)
n_sites <- length(params$codes)
n_confs <- length(params$confs)
n_rows <- n_sites*n_confs
df <- data.frame(Site = rep(NA, n_rows), 
                 Mode = rep(NA, n_rows),
                 Path = rep(NA, n_rows))
df$SiteData = vector("list", n_rows)
df$InputObject = vector("list", n_rows)
df$Result = vector("list",n_rows)
cnt <- 0
df <- tibble::as_tibble(df)
df_general_sites <- data.frame(Plot = rep("", n_sites),
                               Country = rep("", n_sites),
                               Stand = rep("", n_sites),
                               SAPFLUXNET = rep("", n_sites),
                               FLUXNET = rep("", n_sites))

for(i in 1:n_sites) {
  site <- params$codes[i]
  for(j in 1:n_confs) {
    conf <- params$confs[j]
    cnt <- cnt+1
    df$Site[cnt] <- site
    df$Mode[cnt] <- conf
    df$Path[cnt] <- file.path(params$wd, 'Output', packageVersion('medfate')[[1]], params$model, conf, site)
    file_name_input <- file.path(df$Path[cnt],
                       paste0('simulation_input.rds'))
    file_name_output <- file.path(df$Path[cnt],
                       paste0('simulation_result.rds'))
    df$InputObject[[cnt]] <- readRDS(file_name_input)
    df$Result[[cnt]] <-   readRDS(file_name_output)
    site_list  <- medfatereports::load_list(site)
    df$SiteData[[cnt]] <- site_list
    df_general_sites$Plot[i] <- site_list$siteData$Value[1]
    col_country <- which(site_list$siteData$Attribute=="Country")
    df_general_sites$Country[i] <- site_list$siteData$Value[col_country]
    col_sapfluxnet_code <- which(site_list$siteData$Attribute=="SAPFLUXNET code")
    if(length(col_sapfluxnet_code)==1) df_general_sites$SAPFLUXNET[i] <- site_list$siteData$Value[col_sapfluxnet_code]
    col_fluxnet_code <- which(site_list$siteData$Attribute=="FLUXNET code")
    if(length(col_fluxnet_code)==1) df_general_sites$FLUXNET[i] <- site_list$siteData$Value[col_fluxnet_code]
    col_stand <- which(site_list$siteData$Attribute=="Stand description")
    if(length(col_stand)==1) df_general_sites$Stand[i] <- site_list$siteData$Value[col_stand]
  }
}
knitr::opts_knit$set(root.dir = this_path)
```

# Introduction

This document presents **medfate** (**ver. `r packageVersion('medfate')[[1]]`**) model evaluation results at stand-level, using data from a set of **`r length(params$codes)` experimental forest plots**. The main source of observed data is SAPFLUXNET database ([Poyatos et al. 2021](https://essd.copernicus.org/articles/13/2607/2021/)) and FLUXNET 2015 dataset ([Pastorello et al. 2020](https://doi.org/10.1038/s41597-020-0534-3)).


## List of sites

```{r}
df_general_sites |> 
  kbl() |>
  kable_styling()
```

## Simulation and evaluation procedure

Forest water balance simulations (i.e. function `spwb()`) have been conducted using the three transpiration modes (i.e. `Granier`, `Sperry` or `Cochard`). Only soil characteristics have been tuned, but calibration exercises have not been conducted. When available, however, leaf area to sapwood area ratios have been used. Thus, the evaluation is meant to be more or less representative of simulations with default species-level trait data.

For each forest plot, general information about the site, topography, soil and climate is first presented, followed by a description of model inputs (vegetation, soil, custom species parameters and parameterization remarks). 

Evaluation results are presented for different variables:

| Variable                            | Level  | Observation source | Units |
|-------------------------------------|--------|--------------------|-------|
| Total evapotranspiration            | Stand  | Eddy covariance    | mm    |
| Latent heat turbulent flux          | Stand  | Eddy covariance    | MJ/m2 |
| Gross primary productivity          | Stand  | Eddy covariance    | gC/m2 |
| Soil moisture content (topsoil)     | Stand  | SAPFLUXNET         | % vol.|
| Transpiration per leaf area         | Plant  | SAPFLUXNET         | l/m2  |
| Predawn/midday leaf water potential | Plant  | SAPFLUXNET         | MPa   |


```{r, echo=FALSE, results='asis', warning = FALSE, message=FALSE}
 for(i in 1:length(params$codes)) {
   site_code <- params$codes[i]
   site_name <- params$names[i]
   res <- knitr::knit_child(file.path(this_path,'_Stand_Evaluation_child.Rmd'), quiet = TRUE)
   cat(res, sep = '\n')
 }
```



